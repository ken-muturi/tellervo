\chapter{Developing Corina Desktop}
\label{txt:devDesktop}
\index{Developing|(}
\index{Developing!Desktop client}
Corina is open source software and we actively encourage collaboration and assistance from others in the community.  There is always lots to do, even for people with little or no programming experience.  Please get in touch with the development team as we'd love to hear from you.

\section{Source code}
\index{Source code}
This section describes how to access the Corina source code, but as you are no doubt aware it is normal (if not essential) to use a integrated development environment for developing any more than the most simplistic applications.  If you plan to do any development work, it is probably best to skip this section and move straight on to the `Development environment' section which includes instructions for accessing the source code directly from your IDE.  If, however, you just want to browse the source code please continue reading.

The Corina source code is maintained in a Subversion repository at Cornell.  The simplest way to see the source code is via the web viewer on the Cornell website: \url{http://dendro.cornell.edu/svn/corina/}.  You can also examine the Javadoc documentation of the code here \url{http://dendro.cornell.edu/corina/developers.php}

If you have Subversion installed you can do an anonymous checkout of the code as follows:

\code{svn co http://dendro.cornell.edu/svn/corina/}

An overview of the development can be seen through the Corina Ohloh pages at \url{http://www.ohloh.net/p/corina/}.  Ohloh provides graphics summarizing the code over time, including timelines of commits by user.



\section{Development environment}
\index{Eclipse}
\index{Development environment}
\index{Integrated Development Environment (IDE)}
The IDE of choice of the main Corina developers is Eclipse (\url{http://www.eclipse.org}. There are many other IDEs around and there is no reason you can't use them instead.  Either way, the following instructions will hopefully be of use.

We have successfully developed Corina on Mac, Windows and Linux computers over the years.  The methods for setting up are almost identical.  

The first step is to install Eclipse, Sun Java6 JDK, Subversion and Maven.  These are all readily available from their respective websites.  On Ubuntu they can be install from the command line easily as follows:

\code{sudo apt-get install eclipse subversion sun-java6-jdk maven2}

Once installed, you can then launch Eclipse.  To access the Corina source code you will need to install the Subversive plugin to Eclipse.  As of Eclipse v3.5 this can be done by going to \menutwo{Help}{Install new software}.  Select the main Update site in the `Work with' box, then locate the `Subversive SVN Team Provider' plugin under `Collaboration'.  If you are using an earlier version of Eclipse you may need to add a specific Subversive update site.  See the Subversive website (\url{http://www.eclipse.org/subversive/}) for more details.  Once installed you will need to restart Eclipse.

Next you will need to install the m2eclipse Maven plugin to Eclipse.  This can also be installed by going to \menutwo{Help}{Install new software}, however, you will also need to add the Maven update site as this plugin is not currently available in the main Eclipse repository.  You can do this by click the `Add' button and using the URL \url{http://m2eclipse.sonatype.org/sites/m2e}.  Once again you will need to restart Eclipse before continuing.

Next you need to get the Corina source code.  Go to File \menutwo{New}{Project}, then in the dialog select \menutwo{SVN}{Project from SVN}.  There are two methods of accessing the Corina repository: anonymously, in which case you will have read only access; or with a username provided by the Corina development team.  Anonymous users will need to add a repository in the form: \url{http://dendro.cornell.edu/svn/corina/} and full users will need to use \url{svn+ssh://dendro.cornell.edu/home/svn/corina/}.

Once the project has downloaded to your workspace, you may need to set the compliance level.  This can be done by going to \menuthree{Project}{Properties}{Java compiler} and choosing compliance level of 6.0.  Corina uses a handful of Java 6 specific functions, particularly with regards JAXB, so will not run successfully with Java 5.  

To launch Corina, you will need to \menutwo{Run}{Run Java application}.  Create a new run configuration with the main class set to `edu.cornell.dendro.corina.gui.Startup'.     


\section{Dependencies}
\index{Dependencies!Desktop client}
\label{txt:DependenciesDesktopClient}
As of June 2011, Maven is used to build Corina rather than the original Ant.  One of the main benefits of Maven is that it handles dependencies much more dynamically than Ant.  This has become more of an issue as the Corina project as grown, as it is now dependent on over 80 different open source libraries.  

In an ideal world, any libraries that your code is dependent on should be available in central Maven repositories and downloaded and installed seamlessly as part of the build process.  Maven should also handle transient dependencies (i.e. dependencies or dependencies) automatically.  Therefore if a developer knows he needs the functions within a particular library, he simply needs to supply the details of this library without having to worry about the other libraries that this new library is in turn dependent on.  Maven also manages versions much more efficiently.  If a library is dependent on a particular version of another library this is specified within the Maven build mechanism.  This means it is much easier to keep dependencies up-to-date without having to worry about the cascading issues that upgrades often have.  In short, Maven is intended to save developers from `JAR hell'.

In practice, life is not necessarily that simple.  Although Maven assists developers in many ways, it also has its own particular quirks and annoyances.  The main problem is how to handle the situation when the dependencies you need are not available in central repositories.  To solve this you either need to install these jars into your local Maven repository, or make them available in a 3rd party Maven repository.  For the ease of developement we have set up a Maven repository as part of the TRiDaS project which can be browsed at \url{http://maven.tridas.org/}.  This repository is already configured within the Corina project so assuming this repository is still alive, then your Corina project should automatically build.  If not, then you will need to install the few non-standard jars.  These jars will continue to be maintained in the Corina SVN repository and can be installed as follows:

\begin{enumerate}
 \item On your command line navigate to the Libraries folder of your Corina source code
 \item On Linux and Mac you can then simply run the MavenInstallCommands script
 \item On Windows you will need to manually run the commands located in this file
\end{enumerate}

For the record, Corina currently depends upon the libraries listed in table \ref{tbl:desktopDependencies}.  The table also specifies the licenses that these libraries are made available under.


\begin{table*}[htbp]
\centering
\index{File formats}
\begin{tabular*}{0.6\textwidth}{ll}
\toprule
Library & License \\
\midrule
Apache commons lang & Apache 2.0 \\
TridasJLib & Apache 2.0 \\
Batik & Apache 2.0 \\ 
RXTXcomm & LGPL\\
JDOM & Apache 2.0\\
Swing layout & LGPL\\
Log4J & Apache 2.0\\
JNA & LGPL\\
Apache mime 4J & Apache 2.0\\
Commons codec & Apache 2.0\\
Http Client &LGPL\\
Http core & Apache 2.0\\
Http mime &Apache 2.0\\
Jsyntaxpane & Apache 2.0\\
L2prod-common-shared &Apache 2.0\\
L2prod-common-sheet &Apache 2.0\\
l2fprod common buttonbar &Apache 2.0\\
iText &GAPL\\
PDFRenderer & LGPL\\
DendroFileIO & Apache 2.0\\
Java Simple MVC & MIT\\
JGoogleAnalyticsTracker & MIT\\
gluegen & BSD\\
JOGL & BSD+ nuclear clause\\
WorldWindJava & NASA \\
SLF4J & MIT\\
JFontChooser & LGPL\\
MigLayout & BSD\\
PLJava & BSD\\
PostgreSQL & PostgreSQL License (BSD/MIT)\\
Forms & BSD\\
Simplelog & GPLv3\\
JXL & LGPL\\
Wizard & GPLv2\\
Netbeans Swing Outline & GPLv2\\
\bottomrule
\end{tabular*}
\captionsetup{width=0.6\textwidth}
\caption{Corina's primary and major first order dependencies along with the licenses under which they are used.  Note there are a total of 82 libraries upon which Corina draws.}
\label{tbl:desktopDependencies}
\end{table*}


\begin{table*}[htbp]
\centering
\label{tbl:developDependencies}
\index{File formats}
\begin{tabular*}{0.6\textwidth}{ll}
\toprule
Library & License \\
\midrule
Apache commons lang & Apache 2.0 \\
Launch4J & BSD/MIT \\
NSIS & zlib/libpng \\
Ant & Apache 2.0 \\
Eclipse & Eclipse Public License - v1.0\\
ResourceBundle Editor & LGPL \\
M2Eclipse & Eclipse Public License - v1.0\\
Subversive & Eclipse Public License - v1.0\\
\bottomrule
\end{tabular*}
\captionsetup{width=0.6\textwidth}
\caption{Additional tools/libraries typically used in the development of Corina.}
\end{table*}

\section{Code layout}
\index{Developing!Code layout}
Corina has been actively developed since 2000, so has seen contributions by many different developers.  Coding practices have also changed in this time so inevitably there are some inconsistencies with how the source code is organized.  For instance, the most recent interfaces have been implemented using the Model-View-Controller (MVC) architecture whereas earlier interfaces contain both domain and user logic in single monolithic classes.  

Perhaps the most important inconsistency to understand is due to the transistion to the TRiDaS data model.  In earlier versions of Corina used the concept of a `Sample\footnote{To avoid confusing the original Corina class named `Sample' will be referred to as `Corina Sample' throughout this documentation.  Within the code all TRiDaS data model classes are prefixed with `Tridas' to help avoid confusion.  The `Sample' class is therefore not at all associated with the `TridasSample' class.}' to represent each data file.  Although large portions of Corina have been refactored to use the TRiDaS data model classes, there are still some places where the Corina Sample remain.  

\section{Multimedia resources}
\index{Icons}
Corina includes infrastructure for multimedia resources such as icons, images and sounds within the Maven resource folder `src/main/resources'.  The most extensive is the Icons folder which contains many icons at various sizes ranging from $16\times16$ to $512\times512$ as PNG format files.  The icons are accessed via the static Builder class.  This has various accessor functions which take the filename and the size required, and return the icon itself or a URI of the icon from within the Jar.

\section{Translations}
\index{Translations}
There is internationalization infrastructure in place to enable Corina to be offered in multiple languages.  This is done through the use of Resource Bundles, one for each language.  Within the code, whenever a string is required, it is provided using the \verb|I18n.getText()| function which then retrieves the correct string for the current locale.  If no string is found, then the default language (English) string is returned.  There is an Eclipse plugin to assist with this task called ResourceBundle Editor and it can be downloaded from \url{http://eclipse-rbe.sourceforge.net}.  Once installed it provides a GUI that allows you to simultaneously update all languages at once.

The \verb|I18n.getText()| function can be passed variables for insertion into the translation next e.g.\ file name, data value, line number etc.  These can be passed either as a string array, or as one or more strings.  The values are inserted into the translation string at the points marked {0}, {1} etc.  For instance, the translation string ``File {0} exists.  Rename to {1}?'' would accept two strings the first being the original filename and the second being the filename to rename to.  For obvious reasons, only non-translateable strings should be passed in this way as they will be inserted indentically in all languages.

The Resource Bundle also includes support for menu mnemonics (to enable navigation of the menus with the keyboard) and accelerator keys (to enable keyboard shortcuts to bypass menus).  Mnemonic are set by adding an ampersand before the letter of interest (e.g.\ {\&}File for \underline{F}ile) in the resource bundle.  Accelerators are set by adding the keyword `accel' with the key of interest inside square brackets after the resource bundle entry.  Some examples include:

\begin{itemize*}
 \item {\&}Graph active series [accel G]
 \item Graph {\&}component series [accel shift G]
\end{itemize*}

What key the `accel' keyword refers to depends on the operating system Corina is being run on.  In Windows and Linux it is normally `ALT' wheras on a Mac it is usually the Apple ⌘ command key. 


There are currently minimal translations for UK English, German, French, Dutch, Polish and Turkish.  These are by no means complete, and there are number of interfaces that are not internationalized at all.  Further assistance is required from native speakers to complete this task.

\section{Build script}
\label{txt:buildScript}
\index{Developing!Build script}
\index{Packaging}
Corina is built using Maven and is controlled through the pom.xml file stored in the base of the Corina source code.  Earlier versions of Corina used Ant but managing the increasing number of dependencies as Corina has grown become too onerous (see section \ref{txt:DependenciesDesktopClient} for more details). 

Earlier version of Corina used Java WebStart technology to deploy, but this has since been replaced with native installers for the major platforms due to various complications largely associated with Native libraries required for 3D graphics and serial port hardware. 

We use the standard Maven `life cycle' for building, packaging and deploying Corina.  The standard method for doing this in Eclipse is by right clicking on the pom.xml file and selecting \menutwo{Run as}{Maven package} etc.  The main `phases' are as follows:

\begin{description*}
 \item[package] - This compiles Corina and builds a single executable JAR containing all dependencies (thanks to the maven-shade-plugin) along with native Windows, MacOSX and Linux packages.  These are all placed in the `target' folder.
 \item[clean] - This deletes any previously compiled classes and packages in the target folder.  It should only be necessary to run this occassionally if Maven has got a bit confused.
 \item[install] - This installs the compiled jar in your local Maven repository.
 \item[deploy] - This uploads the compiled jar into the maven.tridas.org repository.  Note that you will need to either run this phase from the command line or by setting up a customer run configuration in Eclipse.
\end{description*}



\subsection{Windows installer}
\label{txt:windowsInstaller}
\index{Packaging!Windows}
Maven generates the Windows executable for the Corina application through the 'launch4j' plugin.  Windows users, however, expect an installer that will create menu entries and add uninstall options to the control panel.  An installer is also required to install the user manual and the native libraries required for the serial-port and 3D graphics features in Corina.  

The best open source tool for creating Windows installer scripts is NSIS (see \url{http://nsis.sourceforge.net}).  This is an extremely flexible scripting system that does all we need, although unfortunately it is only officially released for Windows development platforms.  It is possible to install on Linux/MacOSX but this requires a lot of hoop jumping.  

Once installed NSIS can be run using the script `native/WinBuild/nsis.script.nsi'.

\subsection{Mac package}
The Maven osxappbundle plugin is able to produce both .app and .dmg files.  Unfortunately, the libraries for producing .dmg files are proprietary to Apple, as are the libraries that integrate applications into the standard Apple look and feel (e.g. menus at top of screen, integrated quit, preferences and help etc).  When Maven is run on Windows or Linux, it is therefore only able to produce a slightly degraded .app file, and not .dmg.  We therefore recommend producing the Mac release on OSX, either natively or under a virtual machine.


\subsection{Linux Deb package}

\subsection{Linux RPM package}

\subsection{Native libraries}

Although Corina is written in Java, it requires a number of native libraries to make use of OpenGL 3D graphics capabilities and to access the serial port of the computer.  This libraries are different for Windows compared to POSIX systems like Linux and MacOSX.  The correct libraries must be installed to OS specific locations and not within the Corina jar.  They must therefore be included as part of each native installer.

On Windows these libraries take the form of Dynamic Link Libraries (DLL) files which need to be installed in the same folder as the Corina executable:

\begin{itemize*}
 \item gluegen-rt.dll
 \item jogl\_awt.dll
 \item jogl\_cg.dll
 \item jogl.dll
 \item rxtxSerial.dll
\end{itemize*}

On POSIX systems the libraries come as pairs of JNILIB and SO files:

\begin{itemize*}
 \item libgluegen-rt.jnilib and libgluegen-rt.so
 \item libjogl\_awt.jnilib and libjogl\_awt.so
 \item libjogl\_cg.jnilib and libjogl\_cg.so
 \item libjogl.jnilib and libjogl.so
 \item librxtxSerial.jnilib and librxtxSerial.so
\end{itemize*}

On Linux systems this are installed into the /usr/lib folder and on MacOSX they are included within the .app file.

\section{Java Architecture for XML Binding - JAXB}
\label{txt:jaxb}
\index{JAXB}

Java Architecture for XML Binding (JAXB) is a technology that automatically maps Java classes to XML schemas and vice versa.  It includes the ability to \emph{marshall} data from Java classes to XML files and \emph{unmarshall} data from XML files into Java class representations.  

JAXB is used by TridasJLib to create Java class representations of the TRiDaS data model.  It is also used directly in Corina to create classes for the Corina web service.  Although the Corina webservice is based heavily on TRiDaS (the two were developed in parallel), the Corina schema extends TRiDaS by including classes such as dictionaries and the `box' concept which are required for a lab data management application.  

The Corina JAXB classes are automatically built by Maven using the 'maven-jaxb2-plugin' and placed within the `src/main/generated' folder.  Please note that any manual changes to these classes will automatically be overriden the next time Maven is run.  If you feel that changes are necessary to these classes then it is likely that one or more of the following needs modification:

\begin{itemize*}
 \item The Corina schema located in `src/main/resources/schemas'
 \item The Corina JAXB bindings located in `src/main/resources/binding'
 \item The specification for how JAXB is run located in the `pom.xml' file
\end{itemize*}

Please note that JAXB supports plugins and extensions for enhancing the classes that it produces.  One thing to note in the Maven pom.xml is a nasty workaround when running JAXB.  As the Corina schema depends on the GML and TRiDaS schemas, these classes are also built by JAXB.  These classes however are already provided by the DendroFileIO library.  It should be possible to use a feature called `episodes' to handle this but this seems buggy and causes issues.  For now, we use an antrun task to delete the duplicate classes immediately after they are produced.


\section{Java version}
\label{txt:java}
\index{Java}
Although we would like Corina to run on older versions of Java (specifically Java 5), there are a number of features of Java 6 such as JAXB that we really need.  This isn't really a problem on Linux and Windows as Java 6 has been around for a long time now, but it is a bit problematic for MacOSX users.  For reasons unknown Apple was extremely slow bringing Java 6 to MacOSX, only releasing it with 10.6 (Snow Leopard) several years after Windows and Linux.  Corina will therefore not run on older Mac machine.  This will gradually become less of an issue as machines age and ``Snow Leopard or later'' becomes less difficult for users to fulfill.  

Corina has been developed against the Sun JDK.  Although Sun re-released much of its JDK under the GPL license there are still portions that are only available under  proprietary licenses due to various plugins being the copyright of third parties.  Although it is still distributed at no cost, it is not `free' under the terms required by the Free Software Foundation.  Corina can still legally be used with the Sun JDK even though it is regarded as proprietary software due to the `Major components' exception of the GPL license.  However, open source purists find this undesirable and so you may prefer to use open equivalents such as OpenJDK, IcedTea or Apache Harmony.   Basic tests have been performed using OpenJDK and there are some aspects of the Corina code that still need attention.  As Sun continues to open source the JDK, differences between it an OpenJDK will become less and the potential for issues reduced.  We will continue to review the situation and will release an OpenJDK compatible version of Corina as soon as is practical.


\section{Developing graphical interfaces}
\index{Developing!Graphical interfaces}
Like the rest of the code, a number of different styles and methods have been used for the creation of interfaces in Corina.  Many of the earlier interfaces were hand coded, but in recent years WYSIWYG graphical designers have been used to enable the creation of more complex designs.  Most interfaces are now Swing-based although AWT widgets are used in places.

Some interfaces were created using the graphical designed in Netbeans IDE.  These can be identified by the presence of companion .form files and warning comments in the code indicating which sections are autogenerated.  The major drawback with the Netbeans form designer is that it cannot cope with externally made changes.   If changes are made to the files outside of Netbeans, then the Netbeans form designer can no longer edit these files so please make sure you are certain this is how you want to proceed.  The classes generated by Netbeans are typically used by a subclass via inheritance so that any changes can be external to the form designer generated files. 

More recently the Google WindowBuilder Pro tool has been used for interface design.  This has the benefit of (usually) being able to parse existing code enabling the modification of existing dialogs.  WindowsBuilder does have its quirks though so make sure you keep up-to-date with new releases.

\section{Making a new release}
Making a new release should be a relatively quick and simply process, but there are still a few things to remember:

\begin{itemize}
 \item Make sure this documentation is up-to-date!  Use a {\LaTeX} editor to update and compile to PDF.
 \item If this release relies upon a certain version of the Corina server, make sure you set this correctly in `/corina-desktop/src/main/java/edu/cornell/dendro/corina/core/App.java'.  This is important to ensure that users aren't working against an old version of the server which could have unexpected side-effects.
 \item Increment the build version number in the pom.xml
 \item Update the splash screen and background graphics.
 \item Check the code in Eclipse and eliminate as many warnings as possible.
 \item Make sure the developers metadata is correct in the pom.xml.  Add any new developers that have joined the project since the last release.
 \item Go ahead and run Maven package, then build the Windows installer and MacOSX dmg packages.
 \item TEST!
 \item Deploy to maven.tridas.org using Maven.
 \item Copy native packages to the \url{http://dendro.cornell.edu/corina} website .
 \item Update the Corina website to include the new release.
\end{itemize}


\index{Developing|)}